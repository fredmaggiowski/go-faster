<!DOCTYPE html>
<html>
  <head>
    <title>Go Faster | Mia-Platform unconference</title>
    <style>
      button {
        color: white;
        background: red;
        padding: 15px;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translateX(-50%) translateY(-50%);
        -webkit-transform: translate(-50%,-50%);
        transform: translate(-50%,-50%);
        border-radius: 10px;
        cursor: pointer;
        outline: none;
      }
    </style>
  </head>
  <body>
    <div id="messages">
      <div id="no-ws">You have no WebSocket, use a different browser</div>
      <div id="connected-message">You are connected to the game</div>
      <div id="not-connected-message">You are not connected to the game</div>
    </div>
    <div id="admin-console">
        <button id="start-button">START A NEW GAME!</button>
        <button id="stop-button">STOP THE GAME!</button>
    </div>
  </body>
  <script>
    window.onload = () => {
      // Prepare utilities.
      const hide = e => e.style.display = 'none'
      const show = e => e.style.display = 'initial'
      const bootSocket = ({onMessage}) => {
        const socket = new WebSocket("ws://" + document.location.host + "/ws")
        socket.onclose = function (e) {
          var item = document.createElement("div")
          item.innerHTML = '<b>Connection closed.</b>'
        }
        socket.onmessage = function (e) {
          const {data} = e
          onMessage && onMessage(data)
        }
        return socket
      }
      const send = (socket, data) => {console.log('Sending ', data); socket.send(data)}

      // Get useful document references
      let messages = document.getElementById('messages').children
      let adminConsole = document.getElementById('admin-console')
      let startButton = document.getElementById('start-button')
      let stopButton = document.getElementById('stop-button')

      // Hide messages
      Array.from(messages).forEach(h => hide(h))
      hide(adminConsole)
      hide(stopButton)

      // Check WebSocket
      if (!window.WebSocket) {
        show(messages[0])
        return
      }

      const socket = bootSocket({
        onMessage: (data) => {
          const messages = data.split('\n')
          console.log('Recv messages', messages, '[Raw data: ', data, ']')
          const command = data.split(':')
          switch (command[0]) {
            case 'turn':
              goButton.onclick = () => {
                console.log('Button clicked!')
                send(socket, `go:${nameField.value}`)
                hide(goButton)
              }
              show(goButton)
              hide(nameForm)
            break
            default:
              console.warn('Unknown command: ' + command[0] +'.')
          }
          for (let i = 0; i < messages.length; i++) {
            let item = document.createElement("div")
            item.innerText = messages[i]
            console.log('>',item)
          }
        }
      })
      show(adminConsole)

      startButton.onclick = (e) => {
        fetch('/startgame')
          .then(res => {
            show(stopButton)
            hide(startButton)
          })
      }

      stopButton.onclick = (e) => {
        fetch('/stopgame')
          .then(res => {
            hide(stopButton)
            show(startButton)
          })
      }
    }
  </script>
</html>
